format_version: "11"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
  - SAMPLE_APP_URL: https://github.com/bitrise-io/macos-sample-app.git
  - BRANCH: master
  - BITRISE_PROJECT_PATH: macos-sample-app.xcodeproj
  - BITRISE_SCHEME: macos-sample-app
  # define these in your .bitrise.secrets.yml
  - BITRISE_KEYCHAIN_PATH: $BITRISE_KEYCHAIN_PATH
  - BITRISE_KEYCHAIN_PASSWORD: $BITRISE_KEYCHAIN_PASSWORD
  - BITRISE_APPLE_APPLE_CERTIFICATE_URL_LIST: $BITRISE_APPLE_APPLE_CERTIFICATE_URL_LIST
  - BITRISE_APPLE_APPLE_CERTIFICATE_PASSPHRASE_LIST: $BITRISE_APPLE_APPLE_CERTIFICATE_PASSPHRASE_LIST
  - BITRISE_APPLE_PROVISIONING_PROFILE_URL_LIST: $BITRISE_APPLE_PROVISIONING_PROFILE_URL_LIST

workflows:
  test_app_store:
    envs:
    - EXPORT_METHOD: app-store
    - BRANCH: master
    before_run:
    - _common

  test_app_store_with_profile:
    envs:
    - EXPORT_METHOD: app-store
    - BRANCH: provisioning_profile
    before_run:
    - _common

  _common:
    steps:
    - script:
        title: Remove _tmp dir
        inputs:
        - content: |-
            #!/bin/bash1
            set -e
            set -v
            rm -rf ./_tmp
    - change-workdir:
        title: Switch working dir to test/_tmp dir
        inputs:
        - path: ./_tmp
        - is_create_path: true
    - git::https://github.com/bitrise-steplib/bitrise-step-simple-git-clone.git:
        inputs:
        - repository_url: $SAMPLE_APP_URL
        - branch: $BRANCH
        - clone_into_dir: ./
    - certificate-and-profile-installer:
        inputs:
        - certificate_url: $BITRISE_APPLE_APPLE_CERTIFICATE_URL_LIST
        - certificate_passphrase: $BITRISE_APPLE_APPLE_CERTIFICATE_PASSPHRASE_LIST
        - provisioning_profile_url: $BITRISE_APPLE_PROVISIONING_PROFILE_URL_LIST
        - install_defaults: "no"
        - keychain_path: $BITRISE_KEYCHAIN_PATH
        - keychain_password: $BITRISE_KEYCHAIN_PASSWORD
    - path::./:
        title: Step Test
        inputs:
        - project_path: $BITRISE_PROJECT_PATH
        - scheme: $BITRISE_SCHEME
        - is_clean_build: "yes"
        - output_tool: xcodebuild
        - is_export_all_dsyms: "yes"
        - is_export_xcarchive_zip: "yes"
        - export_method: $EXPORT_METHOD
        - verbose_log: "yes"
    - script:
        title: Output tests (generated by the Step)
        inputs:
        - content: |-
            echo "-> BITRISE_EXPORTED_FILE_PATH: ${BITRISE_EXPORTED_FILE_PATH}"
            echo "-> BITRISE_DSYM_PATH: ${BITRISE_DSYM_PATH}"
            echo "-> BITRISE_APP_PATH: ${BITRISE_APP_PATH}"
            echo "-> BITRISE_XCARCHIVE_PATH: ${BITRISE_XCARCHIVE_PATH}"
            echo "-> BITRISE_MACOS_XCARCHIVE_PATH: ${BITRISE_MACOS_XCARCHIVE_PATH}"

  # TODO
  _copy:
    envs:
    - EXPORT_METHOD: none
    - BRANCH: master
    - TEAM_ID: ""
    after_run:
    - _common

    # - path::./:
    #     title: "Step Test: Developer ID"
    #     inputs:
    #     - project_path: $BITRISE_PROJECT_PATH
    #     - scheme: $BITRISE_SCHEME
    #     - is_clean_build: "yes"
    #     - output_tool: xcodebuild
    #     - is_export_all_dsyms: "yes"
    #     - is_export_xcarchive_zip: "yes"
    #     - export_method: developer-id
    #     - verbose_log: "yes"
