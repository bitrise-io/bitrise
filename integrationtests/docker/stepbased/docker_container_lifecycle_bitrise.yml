format_version: "25"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

containers:
  container_a:
    type: execution
    image: frolvlad/alpine-bash:latest
  container_b:
    type: execution
    image: frolvlad/alpine-bash:latest

workflows:
  # Container Lifecycle Management
  # This test verifies:
  # - container_a starts before step 1
  # - container_a is reused (NOT recreated) for step 2
  # - container_a stops and container_b starts before step 3
  # - container_b stops before step 4
  # - No containers remain after workflow completion
  test-lifecycle:
    steps:
    - script@1:
        title: Step 1 - Start container_a
        execution_container: container_a
        inputs:
        - content: |
            #!/bin/bash
            set -e
            echo "Step 1 in container_a"
            echo "Creating marker"
            echo "marker" > /marker.txt

    - script@1:
        title: Step 2 - Reuse container_a
        execution_container: container_a
        inputs:
        - content: |
            #!/bin/bash
            set -e
            echo "Step 2 in container_a"
            if [ -f /marker.txt ]; then
              echo "SUCCESS: Container reused - marker found"
            else
              echo "ERROR: Container recreated - marker not found"
              exit 1
            fi

    - script@1:
        title: Step 3 - Switch to container_b (container_a should stop)
        execution_container: container_b
        inputs:
        - content: |
            #!/bin/bash
            set -e
            echo "Step 3 in container_b"

    - script@1:
        title: Step 4 - No container (container_a should stop)
        inputs:
        - content: |
            #!/bin/bash
            set -e
            echo "Step 4 on host"
