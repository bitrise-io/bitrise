format_version: "25"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

containers:
  alpine:
    type: execution
    image: frolvlad/alpine-bash:latest
  redis:
    type: service
    image: redis:latest
    ports:
    - "6379:6379"
    options: --health-cmd "redis-cli ping" --health-interval 1s

workflows:
  test-execution-container:
    steps:
    - script@1:
        execution_container: alpine
        inputs:
        - content: |
            #!/bin/bash
            set -e
            echo "Running in container"

  test-bundle-execution-container:
    steps:
    - bundle::bundle-with-execution-container:
        execution_container: alpine

  test-service-containers:
    steps:
    - script@1:
        service_containers:
        - redis
        inputs:
        - content: |
            #!/bin/bash
            set -e
            echo "Testing redis service accessibility"

            # NOTE: In production (Linux host), service containers are accessible via localhost:PORT
            # In Docker-in-Docker test environment, we can't test localhost connectivity because:
            # - Port forwarding goes to Docker host (Mac), not the test container
            # - Script runs on host (test container), not on Docker network with service container
            # Therefore, we verify the service is running using docker exec

            # Wait for service to be ready
            sleep 2

            # Verify service container is running and responding
            if docker exec redis redis-cli ping | grep -q "PONG"; then
              echo "Redis service container is running and responsive"
            else
              echo "Redis service container is not responding"
              docker ps | grep redis || true
              exit 1
            fi

  test-bundle-service-container:
    steps:
    - bundle::bundle-with-service-container:
        service_containers:
        - redis

step_bundles:
  bundle-with-execution-container:
    steps:
    - script@1:
        inputs:
        - content: |
            #!/bin/bash
            set -e
            echo "Step Bundle Step 1 running in container"
    - script@1:
        inputs:
        - content: |
            #!/bin/bash
            set -e
            echo "Step Bundle Step 2 running in container"

  bundle-with-service-container:
    steps:
    - script@1:
        inputs:
        - content: |
            #!/bin/bash
            set -e
            echo "Testing redis service accessibility"

            # NOTE: In production (Linux host), service containers are accessible via localhost:PORT
            # In Docker-in-Docker test environment, we can't test localhost connectivity because:
            # - Port forwarding goes to Docker host (Mac), not the test container
            # - Script runs on host (test container), not on Docker network with service container
            # Therefore, we verify the service is running using docker exec

            # Wait for service to be ready
            sleep 2

            # Verify service container is running and responding
            if docker exec redis redis-cli ping | grep -q "PONG"; then
              echo "Redis service container is running and responsive"
            else
              echo "Redis service container is not responding"
              docker ps | grep redis || true
              exit 1
            fi
    - script@1:
        inputs:
        - content: |
            #!/bin/bash
            set -e
            echo "Testing redis service accessibility"

            # NOTE: In production (Linux host), service containers are accessible via localhost:PORT
            # In Docker-in-Docker test environment, we can't test localhost connectivity because:
            # - Port forwarding goes to Docker host (Mac), not the test container
            # - Script runs on host (test container), not on Docker network with service container
            # Therefore, we verify the service is running using docker exec

            # Wait for service to be ready
            sleep 2

            # Verify service container is running and responding
            if docker exec redis redis-cli ping | grep -q "PONG"; then
              echo "Redis service container is running and responsive"
            else
              echo "Redis service container is not responding"
              docker ps | grep redis || true
              exit 1
            fi
